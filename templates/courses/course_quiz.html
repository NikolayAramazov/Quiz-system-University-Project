{% extends "common.html" %}
{% block content %}

<div class="quiz_container">
    <h1>{{ course.title }}</h1>
    <p>Level: {{ course.level }} | Duration: {{ course.duration }}</p>

    <div id="questions">
      {% for q in questions %}
        {% with ua=answers.q.id %}
        <div class="question-card" data-qid="{{ q.id }}">
          <h3>Q{{ q.order }}: {{ q.prompt }}</h3>
          {% if q.info %}
            <p class="info">{{ q.info }}</p>
          {% endif %}

          <input
            type="text"
            class="answer-input"
            placeholder="Type your answer..."
            {% if ua and ua.is_correct %}disabled{% endif %}
            value="{{ ua.answer|default:'' }}"
          >
          <button class="submit-answer">Submit</button>
          <span class="feedback">
            {% if ua %}
              {% if ua.is_correct %}
                ✅ Correct!
              {% else %}
                ❌ Incorrect — try again.
              {% endif %}
            {% endif %}
          </span>
        </div>
        <hr>
        {% endwith %}
      {% endfor %}
    </div>

    <form id="complete-form" action="{% url 'courses:course_complete_check' course.slug %}" method="post">
        {% csrf_token %}
        <button id="complete-course-btn" type="submit" disabled>Complete Course</button>
    </form>
</div>

<script>
const csrfToken = '{{ csrf_token }}';

function allQuestionsCorrect() {
  const cards = document.querySelectorAll('.question-card');
  return Array.from(cards).every(card => card.classList.contains('correct'));
}

function updateButtonState() {
  const button = document.getElementById('complete-course-btn');
  button.disabled = !allQuestionsCorrect();
}

document.querySelectorAll('.submit-answer').forEach(btn => {
  btn.addEventListener('click', async (e) => {
    const card = e.target.closest('.question-card');
    const qid = card.dataset.qid;
    const input = card.querySelector('.answer-input');
    const feedback = card.querySelector('.feedback');
    const answer = input.value.trim();

    const response = await fetch(`/courses/questions/${qid}/check/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      },
      body: JSON.stringify({ answer })
    });

    const result = await response.json();
    if (result.correct) {
      feedback.textContent = "✅ Correct!";
      input.disabled = true;
      card.classList.add('correct');
    } else {
      feedback.textContent = "❌ Incorrect — try again.";
      card.classList.remove('correct');
    }

    updateButtonState();
  });
});
</script>

{% endblock %}
